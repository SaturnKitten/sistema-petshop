{% extends "templates/base.html" %}

{% block content %}
<ol class="breadcrumb mb-2">
  <li class="breadcrumb-item active">Recebimentos</li>
</ol>

<div class="row">
  <div class="col-xl-12">
    <div class="card">
      <div class="card-header d-flex align-items-center justify-content-between">
        <h3 class="m-0">Recebimentos</h3>
        <button class="btn btn-primary" id="btnNovo">Novo Recebimento</button>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table" id="tblRecebimentos">
            <thead><tr id="theadRow"></tr></thead>
            <tbody id="tbodyRows"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal Novo/Editar -->
<div class="modal" tabindex="-1" id="modalForm" style="display:none; background: rgba(0,0,0,.3);">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Novo Recebimento</h5>
        <button type="button" class="btn-close" id="btnCloseModal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <form id="frmRecebimento"></form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="btnCancelar">Cancelar</button>
        <button class="btn btn-primary" id="btnSalvar">Salvar</button>
      </div>
    </div>
  </div>
</div>

<style>
  .modal.show { display:block; }
  .btn-close { border:0; background:transparent; font-size:1.2rem; }
  .form-group { margin-bottom: .75rem; }
  .form-group label { font-weight: 600; margin-bottom: .25rem; display:block; }
</style>

<script>
  // ======== Config ========
  const API = {
    list:  '/GetAllRecebimentos',
    byId:  '/GetRecebimentoByID',
    insert:'/InsertRecebimento',
    update:'/UpdateRecebimento',
    del:   '/DeleteRecebimento'
  };

  const token = localStorage.getItem('jwtToken'); // salve seu JWT aqui após o Login

  // ======== Helpers ========
  const authHeaders = () => ({
    'Authorization': token ? `Bearer ${token}` : '',
    'Content-Type': 'application/json'
  });

  const isIdKey = (k) => ['id','ID'].includes(k);
  const isHiddenKey = (k) => ['removido','Removido'].includes(k);

  function guessInputType(key, value) {
    if (value === null || value === undefined) return 'text';
    if (!isNaN(Number(value))) return 'number';
    const s = String(value);
    if (/^\d{4}-\d{2}-\d{2}/.test(s)) return 'date';
    if (/\d{2}\/\d{2}\/\d{4}/.test(s)) return 'date';
    return 'text';
  }

  function fmtCell(v) {
    if (v == null) return '';
    const s = String(v);
    if (/^\d{4}-\d{2}-\d{2}/.test(s)) {
      const d = new Date(s);
      if (!isNaN(d)) return d.toLocaleDateString();
    }
    return s;
  }

  // ======== Renderização Tabela ========
  function renderTable(data) {
    const thead = document.getElementById('theadRow');
    const tbody = document.getElementById('tbodyRows');
    thead.innerHTML = '';
    tbody.innerHTML = '';

    if (!Array.isArray(data) || data.length === 0) {
      thead.innerHTML = '<th>Nenhum registro</th>';
      return;
    }

    // pegar chaves do primeiro, mantendo colunas úteis e ocultando "removido"
    const keys = Object.keys(data[0]).filter(k => !isHiddenKey(k));
    keys.forEach(k => {
      const th = document.createElement('th');
      th.textContent = k;
      thead.appendChild(th);
    });

    // coluna ações
    const thAc = document.createElement('th');
    thAc.textContent = 'Ações';
    thead.appendChild(thAc);

    // linhas
    data.forEach(item => {
      const tr = document.createElement('tr');
      keys.forEach(k => {
        const td = document.createElement('td');
        td.textContent = fmtCell(item[k]);
        tr.appendChild(td);
      });

      const tdAc = document.createElement('td');
      const idVal = item.ID ?? item.id; // suporta ID ou id
      tdAc.innerHTML = `
        <button class="btn btn-sm btn-warning" data-action="edit" data-id="${idVal}">Editar</button>
        <button class="btn btn-sm btn-danger" data-action="del" data-id="${idVal}">Excluir</button>
      `;
      tr.appendChild(tdAc);
      tbody.appendChild(tr);
    });

    // delegação de eventos ações
    tbody.onclick = async (ev) => {
      const btn = ev.target.closest('button');
      if (!btn) return;
      const id = btn.getAttribute('data-id');
      const action = btn.getAttribute('data-action');
      if (action === 'edit') {
        openEditModal(id);
      } else if (action === 'del') {
        confirmDelete(id);
      }
    };
  }

  // ======== Carregar Lista ========
  async function loadRecebimentos() {
    try {
      const res = await fetch(API.list, { headers: authHeaders() });
      const data = await res.json();
      if (data.status === 'ok') {
        renderTable(data.registro || []);
      } else {
        alert('Falha ao listar recebimentos.');
      }
    } catch (e) {
      console.error(e);
      alert('Erro ao comunicar com o servidor.');
    }
  }

  // ======== Modal Novo / Editar (dinâmico) ========
  function openModal(title) {
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalForm').classList.add('show');
  }
  function closeModal() {
    document.getElementById('modalForm').classList.remove('show');
  }

  // cria inputs dinamicamente com base nas chaves (ignora id/removido)
  function buildFormFromObject(obj, isEdit) {
    const form = document.getElementById('frmRecebimento');
    form.innerHTML = '';
    const keys = Object.keys(obj);
    const idKey = keys.find(k => isIdKey(k));
    if (isEdit && idKey) {
      form.insertAdjacentHTML('beforeend',
        `<input type="hidden" name="${idKey}" value="${obj[idKey]}">`);
    }
    keys.forEach(k => {
      if (isIdKey(k) || isHiddenKey(k)) return;
      const val = obj[k];
      const type = guessInputType(k, val);
      const valueAttr = (type === 'date') ? (String(val).slice(0,10)) : (val ?? '');
      form.insertAdjacentHTML('beforeend', `
        <div class="form-group">
          <label for="field_${k}">${k}</label>
          <input class="form-control" id="field_${k}" name="${k}" type="${type}" value="${valueAttr}">
        </div>
      `);
    });
  }

  async function openEditModal(id) {
    try {
      const res = await fetch(API.byId, {
        method: 'POST',
        headers: authHeaders(),
        body: JSON.stringify({ id: Number(id) })
      });
      const data = await res.json();
      if (data.status !== 'ok' || !Array.isArray(data.registro) || data.registro.length === 0) {
        alert('Registro não encontrado.');
        return;
      }
      const obj = data.registro[0];
      buildFormFromObject(obj, true);
      openModal('Editar Recebimento');
      document.getElementById('btnSalvar').onclick = () => saveEdit();
    } catch (e) {
      console.error(e);
      alert('Erro ao carregar registro.');
    }
  }

  function openNewModal() {
    const base = { 'Descricao': '', 'ValorRecebido': '', 'DataRecebimento': '', 'MetodoPagamento': '' };
    buildFormFromObject(base, false);
    openModal('Novo Recebimento');
    document.getElementById('btnSalvar').onclick = () => saveNew();
  }

  function collectFormPayload() {
    const form = document.getElementById('frmRecebimento');
    const fd = new FormData(form);
    const payload = {};
    fd.forEach((v,k) => {
      payload[k] = v;
    });
    return payload;
  }

  async function saveNew() {
    const body = collectFormPayload();
    try {
      const res = await fetch(API.insert, {
        method: 'POST',
        headers: authHeaders(),
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (data.status === 'ok') {
        closeModal();
        await loadRecebimentos();
      } else {
        alert('Falha ao inserir. ' + (data.status || ''));
      }
    } catch (e) {
      console.error(e);
      alert('Erro ao inserir.');
    }
  }

  async function saveEdit() {
    const body = collectFormPayload();
    try {
      const res = await fetch(API.update, {
        method: 'POST',
        headers: authHeaders(),
        body: JSON.stringify(body)
      });
      const data = await res.json();
      if (data.status === 'ok') {
        closeModal();
        await loadRecebimentos();
      } else {
        alert('Falha ao atualizar. ' + (data.status || ''));
      }
    } catch (e) {
      console.error(e);
      alert('Erro ao atualizar.');
    }
  }

  async function confirmDelete(id) {
    if (!confirm('Excluir este recebimento?')) return;
    try {
      const res = await fetch(API.del, {
        method: 'POST',
        headers: authHeaders(),
        body: JSON.stringify({ id: Number(id) })
      });
      const data = await res.json();
      if (data.status === 'ok') {
        await loadRecebimentos();
      } else {
        alert('Falha ao excluir. ' + (data.status || ''));
      }
    } catch (e) {
      console.error(e);
      alert('Erro ao excluir.');
    }
  }

  // ======== Eventos e bootstrap ========
  document.getElementById('btnNovo').onclick = openNewModal;
  document.getElementById('btnCloseModal').onclick = closeModal;
  document.getElementById('btnCancelar').onclick = (e)=>{ e.preventDefault(); closeModal(); };

  window.addEventListener('DOMContentLoaded', loadRecebimentos);
</script>
{% endblock %}
